let debuging=false
let debugCounter=0
if(debuging)
    game.stats=true

//bg
let bg = img`
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888668888888888888888888888888888888888888866888888888888888888888888888888888888886688888888888888888888888888888888888888668888888
    8888888888888888888888888888888668888888888888888888888888888888888888866888888888888888888888888888888888888886688888888888888888888888888888888888888668888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888886888888888888888888888886888888888888888688888888888888888888888688888888888888868888888888888888888888868888888888888886888888888888888888888886
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888886888888688888888888888888888888888888888688888868888888888888888888888888888888868888886888888888888888888888888888888886888888688888888
    8888888888888888888888888888886968888888888888888888888888888888888888696888888888888888888888888888888888888869688888888888888888888888888888888888886968888888
    8888888888888888888888888888888688888888888888888888888888888888888888868888888888888888888888888888888888888886888888888888888888888888888888888888888688888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888838888888888888888888888888888888888888883888888888888888888888888888888888888888388888888888888888888888888888888888888838888888888888888888888888888888
    8888888838888888888888888888888888888888888888883888888888888888888888888888888888888888388888888888888888888888888888888888888838888888888888888888888888888888
    8888883333388888888888888888888888888888888888333338888888888888888888888888888888888833333888888888888888888888888888888888883333388888888888888888888888888888
    8888888333888888888888888888888888888888888888833388888888888888888888888888888888888883338888888888888888888888888888888888888333888888888888888888888888888888
    8888888383888888888888888888888888888888888888838388888888888888888888888888888888888883838888888888888888888888888888888888888383888888888888888888888888888888
    8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
    8888888888888888888888888888888886888888888888888888888888888888888888888688888888888888888888888888888888888888868888888888888888888888888888888888888886888888
    8888888888888888888888888888888886888688888888888888888888888888888888888688868888888888888888888888888888888888868886888888888888888888888888888888888886888688
    8888888888888888888d888888888888868888888888888888888888888d888888888888868888888888888888888888888d888888888888868888888888888888888888888d88888888888886888888
    888888888888888888ddd8888888888886888888888888888888888888ddd8888888888886888888888888888888888888ddd8888888888886888888888888888888888888ddd8888888888886888888
    8888888888888888888d888888888888666888888888888888888888888d888888888888666888888888888888888888888d888888888888666888888888888888888888888d88888888888866688888
    8888888888888888888888888888888866888888888888888888888888888888888888886688888888888888888888888888888888888888668888888888888888888888888888888888888866888888
    8888888888888888888888688888888886888888888888888888888888888868888888888688888888888888888888888888886888888888868888888888888888888888888888688888888886888888
    8888886888888888888888688888888666688888888888688888888888888868888888866668888888888868888888888888886888888886666888888888886888888888888888688888888666688888
    8888886688888888888886668888888866688888888888668888888888888666888888886668888888888866888888888888866688888888666888888888886688888888888886668888888866688888
    8888886888888888888888688888866666888888888888688888888888888868888886666688888888888868888888888888886888888666668888888888886888888888888888688888866666888888
    8888866688888888888888666888886666668888888886668888888888888866688888666666888888888666888888888888886668888866666688888888866688888888888888666888886666668888
    8888886668888888888886668888888666668888888888666888888888888666888888866666888888888866688888888888866688888886666688888888886668888888888886668888888666668888
    8888866688888888888866668888866666688888888886668888888888886666888886666668888888888666888888888888666688888666666888888888866688888888888866668888866666688888
    6688886668888888888888666888888666666666668888666888888888888866688888866666666666888866688888888888886668888886666666666688886668888888888888666888888666666666
    6666666888888888888866668888666666666666666666688888888888886666888866666666666666666668888888888888666688886666666666666666666888888888888866668888666666666666
    6666666666688888888886666666666666666666666666666668888888888666666666666666666666666666666888888888866666666666666666666666666666688888888886666666666666666666
    6666666666666688888866666666666666666666666666666666668888886666666666666666666666666666666666888888666666666666666666666666666666666688888866666666666666666666
    6666666666667799999999999999776666666666666666666666779999999999999977666666666666666666666677999999999999997766666666666666666666667799999999999999776666666666
    6666666667799999999999999999999977666666666666666779999999999999999999997766666666666666677999999999999999999999776666666666666667799999999999999999999977666666
    6666666799999999999999999999999999997666666666679999999999999999999999999999766666666667999999999999999999999999999976666666666799999999999999999999999999997666
    6666679999999999999999999999996111199977666667999999999999999999999999611119997766666799999999999999999999999961111999776666679999999999999999999999996111199977
    7779999999996999999999999999996999111997777999999999699999999999999999699911199777799999999969999999999999999969991119977779999999996999999999999999996999111997
    9999999999996999999999999999996699911119999999999999699999999999999999669991111999999999999969999999999999999966999111199999999999996999999999999999996699911119
    1999999999996699999999999999966999999111199999999999669999999999999996699999911119999999999966999999999999999669999991111999999999996699999999999999966999999111
    1119999999966699999999999999996999999991111999999996669999999999999999699999999111199999999666999999999999999969999999911119999999966699999999999999996999999991
    9911119999996999999999999999966669999999991111999999699999999999999996666999999999111199999969999999999999999666699999999911119999996999999999999999966669999999
    9999999999966699999999999999996699999999999999999996669999999999999999669999999999999999999666999999999999999966999999999999999999966699999999999999996699999999
    9999999999996669999999999911166619999999999999999999666999999999991116661999999999999999999966699999999999111666199999999999999999996669999999999911166619999999
    9999999999966999999999911119966669999999999999999996699999999991111996666999999999999999999669999999999111199666699999999999999999966999999999911119966669999999
    9999999999966699999991111999996666999999999999999996669999999111199999666699999999999999999666999999911119999966669999999999999999966699999991111999996666999999
    9999999999666669999111199999666669999999999999999966666999911119999966666999999999999999996666699991111999996666699999999999999999666669999111199999666669999999
    9999999999966699111111999999966666699999999999999996669911111199999996666669999999999999999666991111119999999666666999999999999999966699111111999999966666699999
    1111999996666661111199999999666666999911111199999666666111119999999966666699991111119999966666611111999999996666669999111111999996666661111199999999666666999911
    1111111996666699999999999999996666911111111111199666669999999999999999666691111111111119966666999999999999999966669111111111111996666699999999999999996666911111
    1111111166666666999999999996666691111111111111116666666699999999999666669111111111111111666666669999999999966666911111111111111166666666999999999996666691111111
    1111111111666669999999999999666911111111111111111166666999999999999966691111111111111111116666699999999999996669111111111111111111666669999999999999666911111111
    1111111116666666999999999999691111111111111111111666666699999999999969111111111111111111166666669999999999996911111111111111111116666666999999999999691111111111
    1111111166666666661111199999111111111111111111116666666666111119999911111111111111111111666666666611111999991111111111111111111166666666661111199999111111111111
    1111111666666666661119999111111111111111111111166666666666111999911111111111111111111116666666666611199991111111111111111111111666666666661119999111111111111111
    1111111116666666199999111111111111111111111111111666666619999911111111111111111111111111166666661999991111111111111111111111111116666666199999111111111111111111
    1111111166666666699111111111111111111111111111116666666669911111111111111111111111111111666666666991111111111111111111111111111166666666699111111111111111111111
    1111111666666666661111111111111111111111111111166666666666111111111111111111111111111116666666666611111111111111111111111111111666666666661111111111111111111111
    1111111116666666666111111111111111111111111111111666666666611111111111111111111111111111166666666661111111111111111111111111111116666666666111111111111111111111
    1111111666666666661111111111111111111111111111166666666666111111111111111111111111111116666666666611111111111111111111111111111666666666661111111111111111111111
    1111111166666666611111111111111119999911111111116666666661111111111111111999991111111111666666666111111111111111199999111111111166666666611111111111111119999911
    9111111111666666661111111111111991111199911111111166666666111111111111199111119991111111116666666611111111111119911111999111111111666666661111111111111991111199
    9999111666666666661111111111999111111111999911166666666666111111111199911111111199991116666666666611111111119991111111119999111666666666661111111111999111111111
    1199991166666666666111111199111111111111119999116666666666611111119911111111111111999911666666666661111111991111111111111199991166666666666111111199111111111111
    1111999996666661111111199911111111111111111199999666666111111119991111111111111111119999966666611111111999111111111111111111999996666661111111199911111111111111
    1111119999999111111111911111111111111111111111999999911111111191111111111111111111111199999991111111119111111111111111111111119999999111111111911111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
`
scene.setBackgroundImage(bg)


//track
let track=new PumpTrack.Track()
track.sections.push(new PumpTrack.bankTrackSection(0, 90, 0, 87))
// track.sections.push(new PumpTrack.arcTrackSection(51, 60, 48, 43, 13, true))
let lastRangeX2 = track.sections[track.sections.length - 1].rangeX2
const repeatCount=6
for (let i = 0; i < repeatCount;i++){
    const sectionLength=i*56*4
    track.sections.push(new PumpTrack.arcTrackSection(lastRangeX2 + 0 + sectionLength, lastRangeX2 + 112 + sectionLength, lastRangeX2 +56 + sectionLength, 30, 80, false))
    track.sections.push(new PumpTrack.arcTrackSection(lastRangeX2 + 113 + sectionLength, lastRangeX2 + 225 + sectionLength, lastRangeX2 +168 + sectionLength, 145, 80, true))
}
const repeatBulgeCenter = lastRangeX2 + 56 //+24
// start at 0
track.sections[1].rangeX1 = lastRangeX2+1
// expand last arc
const offset = repeatCount * 56 * 4
track.sections.push(new PumpTrack.arcTrackSection(lastRangeX2 + offset, lastRangeX2 + 112 + offset + 10, lastRangeX2 +56 + offset, 30, 80, false))
// add extra platform
lastRangeX2 = track.sections[track.sections.length - 1].rangeX2
track.sections.push(new PumpTrack.lineTrackSection(lastRangeX2, lastRangeX2+30, 87-13))
    // track.sections.push(new PumpTrack.lineTrackSection(130, 150,91))
    // track.sections.push(new PumpTrack.arcTrackSection(150, 290, 200, 30, 79, false))

// track.sections[4] = new PumpTrack.lineTrackSection(track.sections[4].rangeX1, track.sections[4].rangeX2, 86)

//draw track image
if (debuging) info.setLife(track.sections[track.sections.length - 1].rangeX2); pause(11)
// let imgTrack = image.create(track.sections[track.sections.length - 1].rangeX2, 140)
let imgTrack = image.create(160, 120)
if (debuging) info.changeScoreBy(1); pause(11)
// track.draw(imgTrack, debuging ? 0 : 13)
// for (let i = 0; i <= repeatCount; i++) {
//     imgTrack.print("南城陆冲", repeatBulgeCenter - 24 + i * (56 * 4), imgTrack.height - 20, 1, image.font12)
//     imgTrack.print("南城陆冲", repeatBulgeCenter - 24 + i * (56 * 4)-1, imgTrack.height - 20-1, 15, image.font12)
// }
if (debuging) info.changeScoreBy(1); pause(11)
let trackSprite = sprites.create(imgTrack, SpriteKind.Food)
trackSprite.setFlag(SpriteFlag.RelativeToCamera, true)
// trackSprite.top=0
// trackSprite.left=0

if (debuging) info.changeScoreBy(1); pause(11)
//track preview
if(false){
    let cameraStep = 10
    for (let i = 0; i >= 0; i += cameraStep) {
        scene.centerCameraAt(i, 50)
        pause(20 + cameraStep)
        if (i >= imgTrack.width) cameraStep *= -1
}}

// pause(500)


//ball
const ballRadial=7
let ball = sprites.create(sprites.dungeon.collectibleRedCrystal, SpriteKind.Player)
// ball.setPosition(ballRadial+5,88)


let speedBar = sprites.create(image.create(160, 11))
speedBar.setFlag(SpriteFlag.RelativeToCamera, true)
speedBar.top = 0
speedBar.left = 0

//squat pose
let imgBody = img`
    . . . . . . . f f . . . . .
    . . . . f f f f 2 f f . . .
    . . f f e e e e f 2 f f . .
    . f f e e e e e f 2 2 f f .
    . f e e e e f f e e e e f .
    . f f f f f e e 2 2 2 2 e f
    f f f e 2 2 2 f f f f e 2 f
    f f f f f f f f e e e f f f
    f e f e 4 4 e b f 4 4 e e f
    . f e e 4 d 4 b f d d e f .
    . . f e e e 4 d d d e e . .
    . . . f 2 2 2 2 e e d d e .
    . . . f 4 4 4 e 4 4 d d e .
    . . . f f f f f e e e e . .
    . . . f f f f f f f . . . .
`
let imgFoot = img`
    . . . f f f . . f f . . . .
    . . . f f f 1 . f f f 1 . .
    . . . f f f f . f f f f . .
`
const squatLegLength=30
const squatRange=15
const squatCenter=7
let imgPlayer = image.create(imgBody.width + squatLegLength / 2, imgBody.height + squatLegLength)
let player = sprites.create(imgPlayer)
//player.image.drawRect(0, 0, player.image.width, player.image.height,5)
imgPlayer.drawTransparentImage(imgBody, 0,0)
player.setFlag(SpriteFlag.RelativeToCamera, true)
player.left = 80 - 20 - imgBody.width / 2 -2
player.top=20+5
const squatRangeTop = player.y
const squatRangeBottom = squatRangeTop+squatRange
const squatRangeCenter = squatRangeTop+squatCenter

function drawLegs() {
    imgPlayer.fillRect(0, imgBody.height-1, imgPlayer.width, squatLegLength+1, 0)
    const curFootY = 60 - 20 -player.y + 46
    const curLegHeight = curFootY -imgBody.height
    imgPlayer.drawTransparentImage(imgFoot, 0,curFootY)
    
    for (let i = 0; i < (3+2+3); i++) {
        if(i==4||i==3) continue
        imgPlayer.drawLine(3 + i, imgBody.height - 1, 10 + i, imgBody.height + curLegHeight / 2, 15)
        imgPlayer.drawLine(3 + i, curFootY, 10 + i, imgBody.height+curLegHeight / 2, 15)
    }
    
}

game.setDialogFrame(img`
    ...999999999999999999999999999999999999999999...
    ..99999999999999999999999999999999999999999999..
    .9991111999911999111199911119999999911999999999.
    999111111191111911111191111119911191111991111999
    999111111111111111111111111111111111111911111199
    999111111111111111111111111111111111111111111199
    999111111111111111111111111111111111111111111199
    999911111111111111111111111111111111111111111199
    999991111111111111111111111111111111111111111999
    999111111111111111111111111111111111111111111999
    991111111111111111111111111111111111111111119999
    991111111111111111111111111111111111111111111999
    999111111111111111111111111111111111111111111199
    999911111111111111111111111111111111111111111199
    999111111111111111111111111111111111111111111999
    999111111111111111111111111111111111111111119999
    999111111111111111111111111111111111111111111999
    999911111111111111111111111111111111111111111199
    999911111111111111111111111111111111111111111199
    999111111111111111111111111111111111111111111199
    991111111111111111111111111111111111111111111199
    991111111111111111111111111111111111111111111999
    991111111111111111111111111111111111111111119999
    991111111111111111111111111111111111111111111999
    999111111111111111111111111111111111111111111199
    999911111111111111111111111111111111111111111199
    999111111111111111111111111111111111111111111199
    991111111111111111111111111111111111111111111199
    991111111111111111111111111111111111111111111999
    991111111111111111111111111111111111111111119999
    991111111111111111111111111111111111111111119999
    999111111111111111111111111111111111111111111999
    99d1111111111111111111111111111111111dd111111199
    9ddd111111111111111111111111111111111dd111111199
    9ddd1111111111dd111111111111111111111dd1111dd199
    9d1d111111111ddddd11111111111ddddd111ddd111ddd99
    9ddd111ddd111d111d1111ddddd11d111d11dddd111ddd99
    9d1d11ddddd11ddddd1111ddddd11ddddd11d1dd111ddd99
    9ddd11d1d1d11d111d1dd1d1ddd11d111d11dddddddddd99
    9d1d11ddddd11ddddd1dd1ddd1d11ddddddddd1ddd111ddd
    dddd11d1d1d11d111d1dd1ddddd11d111ddddddddddddddd
    dd1d1ddddddddddddd1dd1d1ddddddddddddd1dddd111ddd
    dddd1dd1d1dddd111dddddddd1dddd111ddddddddddddddd
    dd1d1ddddddddddddddddddddddddddddddddd1ddd111ddd
    ddddddddddddddddddddddd1dddddddddddddddddddddddd
    .dddddddddddddddddddddddd1ddddddddddd1dddd111dd.
    ..dddddddddddddddddddddddddddddddddddddddddddd..
    ...dddddddddddddddddddddddddddddddddddddddddd...
`)

const damperFactor = 0.998
const gravity=222

let maxKMH=0
let x = 6, y = 8, vx = 50, vy = 50, ax = 0, ay = 0
game.onUpdate(()=>{
    if (debuging) {
        bg.fill(0)
        bg.print(x.toString(), 0, 20, 1)
        bg.print(y.toString(), 0, 30, 1)
        bg.print(vx.toString(), 0, 40, 2)
        bg.print(vy.toString(), 0, 50, 2)
        bg.print(ax.toString(), 0, 60, 2)
        bg.print(ay.toString(), 0, 70, 2)
    }

    const t = game.currentScene().eventContext.deltaTime
    x += t * vx
    vx += t * ax
    y += t * vy
    vy += t * ay
    track.update(x, y - 1, ballRadial) // ball.y-1: for natrual weight pressure effect
    const degree =  track.tangentDegreeFixed 
    if(isNaN(track.yFixed)){
        track.update(x, y - 1, ballRadial)
    }
    
    //squat
    const playerSpeed=88
    if (controller.down.isPressed()){
        player.vy = -playerSpeed
    } else if (controller.up.isPressed()){
        player.vy = playerSpeed
    }else{
        const delta = player.y - squatRangeCenter
        if (delta<1&&delta>-1){
            player.vy = 0
        }else{
            player.vy = playerSpeed* ((delta>0)?-0.3:0.3)
        }
    }
    if (player.y <= squatRangeTop) {
        player.y = squatRangeTop
        if(player.vy<0) player.vy = 0
    } else if (player.y >= squatRangeBottom) {
        player.y = squatRangeBottom
        if (player.vy > 0)player.vy = 0
    }
    
    drawLegs()

    let force = gravity - player.vy*5
    if(track.isTouched)
    {
        if(!isNaN(track.yFixed)){
        x = track.xFixed
        y = track.yFixed
        }else{
            info.changeLifeBy(1)
        }
        // const v= Math.sqrt(ball.vx**2+ball.vy**2)
        // ball.vx = 
        //          Math.abs(Math.sin(degree)) * (Math.cos(degree) * ball.vx + Math.sin(degree) * ball.vy)
        // + Math.abs(Math.sin(degree)) * (Math.sin(degree) * ball.vy + Math.cos(degree) * ball.vx)
        // ball.vy =  
        //          - Math.cos(degree) * (Math.cos(degree) * ball.vx + Math.sin(degree) * ball.vy)
        //           - Math.cos(degree) * (Math.sin(degree) * ball.vy + Math.cos(degree) * ball.vx)
        vx *= damperFactor
        vy *= damperFactor
        ax = -(Math.cos(degree)) * force * Math.sin(degree)
        ay = -(Math.cos(degree)) * force * Math.cos(degree)
        // bg.print(degree.toString(), 0, 40, 3)
        // info.setScore(degree * 360 / Math.PI / 2)
    } else {
        ax = 0
        ay = force
    }

    ball.setPosition(x, y)

    scene.centerCameraAt(ball.x + 20, ball.y - 10) // player.top + imgBody.height

    track.drawFrame(scene.cameraLeft()+1, scene.cameraTop(), imgTrack, 13)

    speedBar.image.fill(15)
    const kmh = Math.roundWithPrecision(vx / 100 * 3.6,2)
    maxKMH=Math.max(kmh,maxKMH)
    speedBar.image.fillRect(1, 1, maxKMH *10, 8, 13)
    speedBar.image.fillRect(1, 1, kmh *10, 8, 4)
    speedBar.image.print("Spd:" +kmh.toString() + " Max:" + maxKMH.toString(), 2, 1, 1)

    // basic.pause(200)

    if ( controller.A.isPressed()){
        game.showLongText("按键↓蹬腿或展开，按键↑收腿或折叠", DialogLayout.Center)
        game.showLongText("折叠展开动作配合破面角度获得加速", DialogLayout.Center)
        game.showLongText("Tips:下坡时蹬腿，上坡时收腿", DialogLayout.Center)
        game.showLongText("腿的伸缩范围是有限的，想获得最佳成绩就请尝试把伸缩用在最有效的时机", DialogLayout.Center)
        // controller.pauseUntilAnyButtonIsPressed()
    }

    if (ball.x < 0){
        destory()
        game.over(false)
    }
    if (ball.x > track.sections[track.sections.length-1].rangeX2){
        destory()
        game.over(true)
        // controller.pauseUntilAnyButtonIsPressed()
        // game.reset()
    }
})

function destory(){
        imgTrack = null
        imgPlayer=null
        trackSprite.destroy()
        player.destroy()
        ball.destroy()
}

game.onUpdateInterval(50, () => {
    info.setScore(1000 * ball.x / game.runtime())
})